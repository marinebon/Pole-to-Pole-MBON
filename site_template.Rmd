---
title: "Site: `r params$site_name`"
params:
  site_id: "arg-puertomadryn2"
  site_name:  "Punta Cuevas"
editor_options:
  chunk_output_type: console
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, python.reticulate = F)
```

```{r}
library(tidyverse)
library(knitr)
library(leaflet)
library(mapview)
library(leafem)
library(bsplus)
library(robis)
source("functions.R")

if (!exists("params")) 
  params <- list(
  site_name = "Punta Cuevas",
  site_id   = "arg-puertomadryn2")

site <- read_csv(here("data/sites.csv"), col_types=cols()) %>%
  filter(id == params$site_id)

site_photo_csv <- "https://docs.google.com/spreadsheets/d/1-1rIIiH9OV1C7vPzAH4R_PpC1fFj3ZoA6sV8J28Loxc/gviz/tq?tqx=out:csv&sheet=site_photos.csv"

photos <- read_csv(site_photo_csv, col_types=cols()) %>%
  filter(id == params$site_id)

Sys.setenv(RERDDAP_DEFAULT_URL="https://upwell.pfeg.noaa.gov/erddap/")

sst   <- info('jplMURSST41mday')
chl   <- info("VIIRS_OC_NRT_7D"         , url = "https://cwcgom.aoml.noaa.gov/erddap/")
scape <- info("noaa_aoml_4729_9ee6_ab54", url = "https://cwcgom.aoml.noaa.gov/erddap/")
```

- Country: **`r str_to_upper(site$country)`**
- Organization: **`r site$org`**

## Photos

```{r}
if (nrow(photos) > 0){
  carousel <- bs_carousel(id = "photos", use_indicators = TRUE)

  for (i in 1:nrow(photos)){
    photo <- photos[i,]
    carousel <-  bs_append(
      carousel,
      content = bs_carousel_image(src = photo$url),
      caption = bs_carousel_caption(photo$caption))
  }

  carousel
} else {
  cat("No photos yet posted.")
}
```

## Maps {.tabset}

### Temperature

```{r}
# get most recent date
d <- get_dates(sst)[2]
```

Map of the most recent (`r format(d,"%Y-%m-%d")`) sea-surface temperature around the site. Data source: PFEG CoastWatch via ERDDAP.

```{r}
# box <- get_box(site$lon, site$lat, cells_wide=10)
# r   <- get_raster(sst, lon=box$lon, lat=box$lat, date="last", field="sst")
# map_raster(r, site_lon=site$lon, site_lat=site$lat, site_label=site$name, title="SST")

# bounding box offset around site marker for extent of map
b <- 3.0

leaflet(
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://coastwatch.pfeg.noaa.gov/erddap/wms/jplMURSST41mday/request?',
    layers = "jplMURSST41mday:sst",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d,"%Y-%m-%dT00:00:00Z")))  %>%
  addMarkers(lng = ~lon, lat = ~lat, label = ~name, data=site) %>%
  addMouseCoordinates() %>%
  fitBounds(site$lon - b, site$lat - b, site$lon + b, site$lat + b) %>%
  addLegend(
    position="bottomright",
    title = paste0("SST (Â°C)<br>", format(d,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,32), reverse=T), seq(0,32))
```

### Chlorophyll

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# get most recent date
d_2 <- get_dates(chl)[2]
```

Map of the most recent (`r format(d_2, "%Y-%m-%d")`) Chlorophyll-a around the site. Data Source: PFEG CoastWatch via ERDDAP.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# box_2 <- get_box(site$lon, site$lat, cells_wide=10)
# r_2   <- get_raster(chl, lon=box$lon, lat=box$lat, date="last", field="chl")
# map_raster(r, site_lon=site$lon, site_lat=site$lat, site_label=site$name, title="CHL")

# bounding box offset around site marker for extent of map
b_2 <- 3.0

leaflet(
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://cwcgom.aoml.noaa.gov/erddap/wms/VIIRS_OC_NRT_7D/request?',
    layers = "VIIRS_OC_NRT_7D:chlor_a",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addMarkers(lng = ~lon, lat = ~lat, label = ~name, data=site) %>%
  addMouseCoordinates() %>%
  fitBounds(site$lon - b_2, site$lat - b_2, site$lon + b_2, site$lat + b_2) %>%
  addLegend(
    position="bottomright",
    title = paste0("CHL (mg m^-3)<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(0,4), reverse=T), seq(0,4))
```

### Seascape

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# get most recent date
d_2 <- get_dates(scape)[2]
```

Map of the most recent (`r format(d_2, "%Y-%m-%d")`) seascapes around the site. Data Source: AOML CWCGOM via ERDDAP.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# box_2 <- get_box(site$lon, site$lat, cells_wide=10)
# r_2   <- get_raster(chl, lon=box$lon, lat=box$lat, date="last", field="chl")
# map_raster(r, site_lon=site$lon, site_lat=site$lat, site_label=site$name, title="CHL")

# bounding box offset around site marker for extent of map
b_2 <- 3.0

leaflet(
  options = leafletOptions(
    crs = leafletCRS(crsClass = "L.CRS.EPSG4326"))) %>%
  # basemap from GBIF in 4326
  addTiles("//tile.gbif.org/4326/omt/{z}/{x}/{y}@1x.png?style=gbif-geyser") %>%
  # sst
  addWMSTiles(
    baseUrl = 'https://cwcgom.aoml.noaa.gov/erddap/wms/noaa_aoml_4729_9ee6_ab54/request?',
    layers = "noaa_aoml_4729_9ee6_ab54:CLASS",
    options = WMSTileOptions(
      version = "1.3.0", format = "image/png", transparent = T, opacity = 0.7,
      time = format(d_2,"%Y-%m-%dT00:00:00Z")))  %>%
  addMarkers(lng = ~lon, lat = ~lat, label = ~name, data=site) %>%
  addMouseCoordinates() %>%
  fitBounds(site$lon - b_2, site$lat - b_2, site$lon + b_2, site$lat + b_2) %>%
  addLegend(
    position="bottomright",
    title = paste0("CLASS<br>", format(d_2,"%Y-%m-%d")),
    colorNumeric("Spectral", c(1,33), reverse=T), seq(1,33))
```

Read more about seascapes [here](https://coastwatch.noaa.gov/cw/satellite-data-products/multi-parameter-models/seascape-pelagic-habitat-classification.html).

## Timeseries {.tabset}

### Temperature

```{r, echo=FALSE, message=FALSE, warning=FALSE}
csv <- here(glue("data/sst/sst_{site$id}.csv"))
d   <- get_timeseries(sst, lon=site$lon, lat=site$lat, csv=csv, field="sst")
plot_timeseries(d, title="SST", color="red")
```

Download data: [`r basename(csv)`](https://raw.githubusercontent.com/marinebon/p2p/master/data/sst/`r basename(csv)`)

```{python, eval=F}
# transform something like
#    https://marinebon.github.io/home/travis/build/marinebon/p2p/data/sst/sst_wi-maracas.csv
# into
#    https://raw.githubusercontent.com/marinebon/p2p/master/data/sst/sst_wi-maracas.csv
csv = str(r.csv).replace("/marinebon/p2p/data/", "/marinebon/p2p/master/data/")
csv_link = "https://raw.githubusercontent.com/" + csv.split("/marinebon/p2p/")[1]
```

### Chlorophyll

```{r, echo=FALSE, message=FALSE, warning=FALSE}
csv   <- here(glue("data/chl/chl_{site$id}.csv"))

# TODO: fix get_timeseries() -> griddap() -> erd_up_GET()
Sys.setenv(RERDDAP_DEFAULT_URL="https://cwcgom.aoml.noaa.gov/erddap/")

d_chl <- get_timeseries(chl, lon=site$lon, lat=site$lat, csv=csv, field="chlor_a")
plot_timeseries(d_chl, title="CHL", color="green")

Sys.setenv(RERDDAP_DEFAULT_URL="https://upwell.pfeg.noaa.gov/erddap/")
```

Download data: [`r basename(csv)`](https://raw.githubusercontent.com/marinebon/p2p/master/data/chl/`r basename(csv)`)

## Taxonomic records in [OBIS](https://obis.org/) {.tabset}

### Time Series
```{r, echo=FALSE, message=FALSE, warning=FALSE}

## query OBIS records
# total = occurrence(areaid = site$area_code, taxonid = c(51, 1806, 882, 3))
# setwd("~/p2p/data/obis")
# sel_area <- site$area_code
# filename <- glue("obis_{sel_area}.csv")
# total <- read.csv(filename)

polygon <- site$area_code

if (polygon > 0)
{total <- occurrence(areaid = polygon, taxonid = c(51, 1806, 882, 3))
} else if(polygon == -9999){
    val <- .25
    lat <- site$lat
    lon <- site$lon
    latmin <- lat - val
    latmax <- lat + val
    lonmin <- lon - val
    lonmax <- lon + val
  polygon <- glue("POLYGON (({lonmin} {latmin}, {lonmin} {latmax}, {lonmax} {latmax}, {lonmax} {latmin}, {lonmin} {latmin}))")
  options(show.error.messages = FALSE)
  total <- try(occurrence(taxonid = c(51, 1806, 882, 3), geometry = polygon))
  if("try-error" %in% class(total)) total <- occurrence(areaid = 40003, taxonid = c(51, 1806, 882, 3))
}

## Plot the data
total2 <- data.frame(total$date_year, total$phylum)
names(total2)[names(total2) == "total.date_year"] <- "year"
names(total2)[names(total2) == "total.phylum"] <- "phylum"
# title <- glue("Data source: https://obis.org/area/{site$area_code}")
ts_plot <- ggplot() +
  geom_histogram(data = total2, aes(x = year, fill = phylum), binwidth = 3) +
  scale_fill_brewer(palette = "Spectral") +
#  xlim(c(1960, 2017)) +
#  labs(title = title) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  theme(axis.text.x = element_text(size=14, angle=0),
        axis.text.y = element_text(size=14, angle=0))
ts_plot


```

### Maps

**Mollusca**
```{r, echo=FALSE, message=FALSE, warning=FALSE}
mollusc <- filter(total, phylum == "Mollusca")

if (length(mollusc) == 0)
{print("No data")
  } else if(length(mollusc) > 0){m <- leaflet(mollusc) %>%
  addTiles()  %>%
  setView( lat=site$lat, lng=site$lon, zoom=10) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(~mollusc$decimalLongitude, ~mollusc$decimalLatitude,
                   fillOpacity = 0.7, color="yellow", radius=7, stroke=FALSE,
                   labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto")
  )
m}
```

**Echinodermata**
```{r, echo=FALSE, message=FALSE, warning=FALSE}
echino <- filter(total, phylum == "Echinodermata")

if (length(echino) == 0)
{print("No data")
  } else if(length(echino) > 0){m2 <- leaflet(echino) %>%
  addTiles()  %>%
  setView( lat=site$lat, lng=site$lon, zoom=10) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(~echino$decimalLongitude, ~echino$decimalLatitude,
                   fillOpacity = 0.7, color="red", radius=7, stroke=FALSE,
                   labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto")
  )
m2}
```

**Annelida**
```{r, echo=FALSE, message=FALSE, warning=FALSE}
anne <- filter(total, phylum == "Annelida")

if (length(anne) == 0)
{print("No data")
  } else if(length(anne) > 0){m3<- leaflet(anne) %>%
  addTiles()  %>%
  setView( lat=site$lat, lng=site$lon, zoom=10) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(~anne$decimalLongitude, ~anne$decimalLatitude,
                   fillOpacity = 0.7, color="white", radius=7, stroke=FALSE,
                   labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto")
  )
m3}
```

**Plantae**
```{r, echo=FALSE, message=FALSE, warning=FALSE}
plant <- filter(total, kingdom == "Plantae")

if (length(plant) == 0)
{print("No data")
  } else if(length(plant) > 0){m4 <- leaflet(plant) %>%
  addTiles()  %>%
  setView( lat=site$lat, lng=site$lon, zoom=10) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(~plant$decimalLongitude, ~plant$decimalLatitude,
                   fillOpacity = 0.7, color="orange", radius=7, stroke=FALSE,
                   labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto")
  )
m4}
```

## Data source:
Data shown here is extracted using the [occurrence](https://www.rdocumentation.org/packages/robis/versions/1.0.1/topics/occurrence) function of the [robis](https://www.rdocumentation.org/packages/robis/versions/1.0.1) package within polygons (e.g. EEZ, WMHS) or a 0.25 x 0.25 degrees box centered at monitoring site in data-rich regions.